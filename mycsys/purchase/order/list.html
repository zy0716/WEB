


<div id="toolbar">
    <!-- <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-add" onclick="newItem('purchase/order/form')">药品采购</a> -->
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-remove" onclick="destroyItems('purchase/order/deleteitems')">删除采购订单</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="wy-icon-send-record"  onclick="sendTo('purchase/order/send_to_check')">生成采购记录并发给验收员</a>
</div>


<div id="ly" class="easyui-layout" fit="true" border="false">
    <div region="center" title="数据列表" iconCls="wy-icon-table" border="false" >
        <!-- <div class="wy-centerbox"> -->
        <!-- 列表开始 -->
        <table id="dg" url="purchase/order/listjson" >
            <thead data-options="frozen:true">
            <tr>
                <th data-options="field:'id',checkbox:true" rowspan="2"></th>
                <th field="send" formatter="sendRowformater" halign="center" rowspan="2">状态</th>
            </tr>
            </thead>
            <thead>
            <tr>
                <th colspan="5">采购信息</th>
                <th colspan="13">药品信息</th>
            </tr>
            <tr>
                <!-- 采购信息 -->
                <th field="priceString" halign="center" align="right">单价(元)</th>
                <th field="countSplitSpecificationsString" halign="center" align="right">数量</th>
                <th field="totalPriceString" halign="center" align="right">金额(元)</th>
                <th field="purchaseDate" halign="center">采购日期</th>
                <th field="buyer" halign="center">采购员</th>
                <!-- 药品信息 -->
                <th field="genericName" halign="center">通用名称</th>
                <th field="productName" halign="center">商品名称</th>
                <th field="dosageForm" halign="center">剂型</th>
                <th field="specification" halign="center">规格</th>
                <th field="manufacturer" halign="center">生产厂商</th>
                <th field="vendor" halign="center">供货单位</th>
                <th field="approvalNumber" halign="center">批准文号</th>
                <th field="drugRang" halign="center">药品范围</th>
                <th field="storageCondition" halign="center">储存条件</th>
                <th field="drugCategory" halign="center">药品类别</th>
                <th field="openStockString" halign="center">是否拆零(拆零规格)</th>
                <th field="controlledDrugString" halign="center">管制药品(管制类别|管制数量)</th>
                <th field="chineseMedicineArea" halign="center">中药饮片产地</th>
            </tr>
            </thead>
        </table>
        <!-- 列表结束 -->
        <!-- </div> -->
    </div>
    <div region="south" style="height:400px;" split="true" border="false" title="选择药品" iconCls="icon-add">
        <div class="wy-centerbox">
            <form id="fm" method="post" action="purchase/order/save">
                <input type="hidden" name="id" >
                <input type="hidden" name="drugId" >
                <table class="wy-form-table wy-search-table">

                    <tr>
                        <td rowspan="2" width="48"><img src="images/Search-11.png"></td>
                        <td>请输入供货单位：</td>
                        <td>
                            <input id="select_vendor"  style="width:300px">
                        </td>
                        <td rowspan="2">
                            <a id="saveBtn" href="javascript:void(0)" class="easyui-linkbutton" style="vertical-align:middle;" iconCls="wy-icon-save" onclick="selectDrug();">保存订单</a>
                            <a href="javascript:void(0)" class="easyui-linkbutton" style="vertical-align:middle;" onclick="clearFormInfo()">清空</a>
                        </td>
                    </tr>
                    <tr>
                        <td width="160">请输入药品通用名称：</td>
                        <td  width="320"><input id="select_drug"  style="width:300px" /></td>
                    </tr>
                </table>
                <table class="wy-form-table">
                    <tr>
                        <td>数量：</td>
                        <td>
                            <input id="count" name="count" type="text" class="textinputnumber easyui-numberbox" required="true" />
                            <span class="splitSpecifications"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>单价(元)：</td>
                        <td><input id="price" name="price" type="text" class="textinputnumber easyui-numberbox" required="true" precision="2" /></td>
                    </tr>
                    <tr>
                        <td class="table-title">通用名称：</td>
                        <td><span id="genericName"></span></td>
                    </tr>
                    <tr>
                        <td>商品名称：</td>
                        <td><span id="productName"></span></td>
                    </tr>
                    <tr>
                        <td>剂型：</td>
                        <td><span id="dosageForm"></span></td>
                    </tr>
                    <tr>
                        <td>规格：</td>
                        <td><span id="specification"></span></td>
                    </tr>
                    <tr>
                        <td>生产厂商：</td>
                        <td><span id="manufacturer"></span></td>
                    </tr>
                    <tr>
                        <td>供货单位：</td>
                        <td><span id="vendor"></span></td>
                    </tr>
                    <tr>
                        <td>批准文号：</td>
                        <td><span id="approvalNumber"></span></td>
                    </tr>
                    <tr>
                        <td>药品范围：</td>
                        <td><span id="drugRang"></span></td>
                    </tr>
                    <tr>
                        <td>储存条件：</td>
                        <td><span id="storageCondition"></span></td>
                    </tr>
                    <tr>
                        <td>药品类别：</td>
                        <td><span id="drugCategory"></span></td>
                    </tr>
                    <tr>
                        <td>是否拆零(拆零规格)：</td>
                        <td><span id="openStock"></span></td>
                    </tr>
                    <tr>
                        <td>管制药品(类别|数量)：</td>
                        <td><span id="controlledDrug"></span></td>
                    </tr>

                    <tr>
                        <td>中药饮片产地：</td>
                        <td><span id="chineseMedicineArea"></span></td>
                    </tr>
                </table>
            </form>
        </div>

        <script type="text/javascript">
            $('#select_vendor').combogrid({
                delay: 500,
                panelWidth:300,
                url:'purchase/order/list_all_vendor_json.json',
                idField:'id',
                textField:'name',
                mode:'remote',
                columns:[[
                    {field:'name',title:'企业名称'}
                ]],
                onSelect:function(rowIndex, rowData){
                    var url = 'purchase/order/list_drug_by_vendor_json.json';
                    $('#select_drug').combogrid({url:url});
                    //药品
                    clearDrugTable();
                    //id
                    $('#fm')[0].drugId.value = '';
                    $('#fm')[0].id.value = '';
                    //采购信息
                    $('#count').numberbox('setValue','');
                    $('#price').numberbox('setValue','');

                }
            });

            $('#select_drug').combogrid({
                delay: 500,
                panelWidth:690,
                idField:'id',
                textField:'genericName',
                mode:'remote',
                columns:[[
                    {field:'genericName',title:'通用名称'},
                    {field:'productName',title:'商品名称'},
                    {field:'dosageForm',title:'剂型'},
                    {field:'specification',title:'规格'},
                    {field:'manufacturer',title:'生产厂商'}
                ]],
                onSelect:function(rowIndex, rowData){
                    //药品
                    showDrugTable(rowData);
                    $('#vendor').text(rowData.vendor.name);
                    //id
                    $('#fm')[0].drugId.value = rowData.id;
                    $('#fm')[0].id.value = '';
                    //采购信息
                    $('#count').numberbox('setValue','');
                    $('#price').numberbox('setValue','');
                }
            });


            function clearFormInfo(){
                $('#fm').form('clear');
                clearDrugTable();
            }

            function selectDrug(){

                var thisform = $('#fm');
                thisform.form('submit',{
                    url: thisform[0].action,
                    onSubmit: function(){

                        if($('#select_drug').combogrid('getValue') == '' || $('#genericName').text() == ''){
                            showWarn('请选择药品');
                            return false;
                        }

                        if(!$(this).form('validate')){
                            showWarn('请检查数据是否填写完整和正确');
                            return false;
                        }

                        $('#saveBtn').linkbutton('disable');
                        return true;
                    },
                    success: function(result){

                        result = eval('(' + result + ')');  // change the JSON string to javascript object
                        if (result.msg == "success"){

                            $('#dg').datagrid('reload'); // reload the user data

                            //显示提示
                            showMsg(result.txt);
                            clearFormInfo();
                        }else if(result.msg == "error"){
                            showWarn(result.txt);
                        }

                        $('#saveBtn').linkbutton('enable');
                    }
                });
            }

        </script>

    </div>
</div>

<script type="text/javascript">

    $('#dg').datagrid({
        rownumbers: true,
        pagination: true,
        singleSelect:false,
        striped: true,
        toolbar: '#toolbar',
        pageSize: 20
    });

    function sendRowformater(value,row,index){

        if(value){
            return '<lable style="color:green;">已发送</label>';
        }else{
            return '<lable style="color:red;">未发送</label>';
        }
    }


</script>